<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Editor de Cursos IFPA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {--verde:#2e7d32;--azul:#1565c0;--cinza:#6c757d}
    body{background:#f8f9fa;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    .container{max-width:1100px}
    .toolbar{background:#fff;border:1px solid #dee2e6;border-radius:12px;padding:1rem;margin:1rem 0}
    .table-editor{background:#fff;border:1px solid #dee2e6;border-radius:12px;overflow:hidden}
    table thead th{background:#f1f3f5}
    .badge-status{font-size:.75rem}
    .editor-actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .form-control, .form-select{min-width:120px}
    .col-flex{display:flex;gap:.5rem;flex-wrap:wrap}
    .small-note{font-size:.85rem;color:#6c757d}
    .changed{border-color:#ffc107!important;box-shadow:0 0 0 .2rem rgba(255,193,7,.25)!important}
    .is-invalid{border-color:#dc3545!important;box-shadow:0 0 0 .2rem rgba(220,53,69,.25)!important}
    .row-dirty{background:#fff8e1}
    .lbl-sm{font-size:.75rem;color:#6c757d;margin-bottom:.2rem;display:block}
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mt-3 mb-2">Editor de Cursos IFPA</h2>
    <p class="small-note">Carregue do site ou de um arquivo, edite e salve localmente para envio ao administrador.</p>

    <div class="toolbar d-flex justify-content-between align-items-center">
      <div class="d-flex gap-2">
        <button id="btn-abrir" class="btn btn-primary"><i class="bi bi-folder2-open me-1"></i>Abrir</button>
        <button id="btn-salvar-menu" class="btn btn-success"><i class="bi bi-save me-1"></i>Salvar</button>
        <button id="btn-novo-curso" class="btn btn-outline-success"><i class="bi bi-plus-lg me-1"></i>Novo curso</button>
      </div>
      <div class="input-group" style="max-width:420px">
        <span class="input-group-text">Campus exibido</span>
        <input id="input-campus-nome" type="text" class="form-control" placeholder="IFPA campus BRAGANÇA">
      </div>
    </div>

    <div class="toolbar">
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <select id="filtro-categoria" class="form-select">
            <option value="">Todas categorias</option>
            <option value="integrado">Integrado</option>
            <option value="subsequente">Subsequente</option>
            <option value="graduacao">Graduação</option>
            <option value="pos">Pós-Graduação</option>
            <option value="fic">FIC</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="filtro-status" class="form-select">
            <option value="">Todos status</option>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
            <option value="Sem oferta">Sem oferta</option>
          </select>
        </div>
        <div class="col-md-6">
          <input id="filtro-texto" type="text" class="form-control" placeholder="Buscar por nome, coordenador ou descrição">
        </div>
      </div>
    </div>

    <div id="editor-sections" class="table-editor p-3">
      <div id="section-integrado" class="mb-3"></div>
      <div id="section-subsequente" class="mb-3"></div>
      <div id="section-graduacao" class="mb-3"></div>
      <div id="section-pos" class="mb-3"></div>
      <div id="section-fic" class="mb-3"></div>
    </div>

    <div class="mt-3 small-note">O arquivo gerado contém a chave <code>cursos</code> e opcionalmente <code>campus</code>.</div>
  </div>

  <div class="modal fade" id="modalAbrir" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Abrir</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2">
            <button id="btn-listar-site" class="btn btn-outline-primary"><i class="bi bi-cloud-download me-1"></i>Listar /cursos</button>
            <button id="btn-abrir-local-modal" class="btn btn-outline-secondary"><i class="bi bi-folder2-open me-1"></i>Abrir JSON local</button>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text">URL</span>
            <input id="input-url" type="text" class="form-control" placeholder="https://osnisanches.github.io/ifcode/cursos/braganca.json">
            <button id="btn-carregar-url-modal" class="btn btn-primary">Carregar</button>
          </div>
          <div id="lista-remota" class="list-group"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalSalvar" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Salvar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-ordenar" checked>
            <label class="form-check-label" for="chk-ordenar">Ordenar por status, categoria e nome</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-validar" checked>
            <label class="form-check-label" for="chk-validar">Validar dados antes de salvar</label>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btn-salvar" class="btn btn-success"><i class="bi bi-save me-1"></i>Salvar JSON</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function sanitizeCampusParam(v){return (v||'').toLowerCase().replace(/[^a-z0-9-]/g,'')}
    function formatCampusDisplay(raw,campusParam){if(raw){var m=raw.match(/IFPA\s*(?:Campus|campus)\s*(.+)/i);var name=m?m[1].trim():raw.trim();return 'IFPA campus '+name.toUpperCase()}var sub=campusParam||'ifpa';return 'IFPA campus '+sub.toUpperCase()}
    function datasetUrl(campusParam){var cp=sanitizeCampusParam(campusParam);var use=cp||'ifpa';return 'https://osnisanches.github.io/ifcode/cursos/'+use+'.json'}

    const BASE_DIR='https://osnisanches.github.io/ifcode/cursos/'
    const categorias=['integrado','subsequente','graduacao','pos','fic']
    const statusList=['Ativo','Inativo','Sem oferta']
    let state={campus:'',cursos:[]}
    let originalState={campus:'',cursos:[]}
    let filtros={categoria:'',status:'',texto:''}

    function render(){document.getElementById('input-campus-nome').value=state.campus||'';const sections={integrado:document.getElementById('section-integrado'),subsequente:document.getElementById('section-subsequente'),graduacao:document.getElementById('section-graduacao'),pos:document.getElementById('section-pos'),fic:document.getElementById('section-fic')};Object.keys(sections).forEach(k=>{sections[k].innerHTML=''});const matches=(c)=>{if(filtros.categoria&&c.categoria!==filtros.categoria)return false;if(filtros.status&&c.status!==filtros.status)return false;if(filtros.texto){const t=filtros.texto.toLowerCase();const blob=(c.nome||'')+' '+(c.coordenador||'')+' '+(c.descricao||'');if(!blob.toLowerCase().includes(t))return false}return true};const byCat={integrado:[],subsequente:[],graduacao:[],pos:[],fic:[]};state.cursos.forEach((c,i)=>{if(matches(c))byCat[c.categoria]?.push({c,i})});Object.entries(byCat).forEach(([cat,list])=>{list.sort((a,b)=>{const na=originalState.cursos[a.i]?1:0;const nb=originalState.cursos[b.i]?1:0;return na-nb});const container=document.getElementById('section-'+cat);const title='<div class="d-flex justify-content-between align-items-center mb-2"><h5 class="mb-0 text-capitalize">'+cat+'</h5><span class="badge bg-light text-dark">'+list.length+'</span></div>';container.insertAdjacentHTML('beforeend',title);list.forEach(({c,i})=>{const badge=c.status==='Ativo'?'bg-success':(c.status==='Inativo'?'bg-secondary':'bg-warning');const id='item-'+cat+'-'+i;const card='<div class="card mb-2 '+(originalState.cursos[i]?'':'row-dirty')+'"><div class="card-body d-flex justify-content-between align-items-center"><div><span class="badge '+badge+' me-2">'+(c.status||'')+'</span><strong>'+(c.nome||'')+'</strong><small class="text-muted ms-2">#'+(c.id||'')+'</small></div><div class="d-flex gap-2"><button class="btn btn-sm btn-outline-primary" data-edit="'+id+'">Editar</button><button class="btn btn-sm btn-outline-danger" data-del="'+i+'">Excluir</button></div></div><div class="collapse" id="'+id+'"><div class="p-3 border-top">'+courseFormHtml(c)+'</div></div></div>';container.insertAdjacentHTML('beforeend',card)});});wireCourseEvents();autoExpandNew()}

    function courseFormHtml(c){return (
      '<div class="row g-2">'+
      '<div class="col-2"><label class="lbl-sm">ID</label><input data-f="id" type="number" class="form-control form-control-sm" value="'+(c.id||'')+'"/></div>'+
      '<div class="col-6"><label class="lbl-sm">Nome</label><input data-f="nome" type="text" class="form-control form-control-sm" value="'+(c.nome||'')+'"/></div>'+
      '<div class="col-2"><label class="lbl-sm">Categoria</label><select data-f="categoria" class="form-select form-select-sm">'+categorias.map(cat=>'\n<option '+(c.categoria===cat?'selected':'')+' value="'+cat+'">'+cat+'</option>').join('')+'</select></div>'+
      '<div class="col-2"><label class="lbl-sm">Status</label><select data-f="status" class="form-select form-select-sm">'+statusList.map(s=>'\n<option '+(c.status===s?'selected':'')+' value="'+s+'">'+s+'</option>').join('')+'</select></div>'+
      '<div class="col-2"><label class="lbl-sm">Vagas</label><input data-f="vagas" type="number" class="form-control form-control-sm" value="'+(c.vagas!=null?c.vagas:'')+'"/></div>'+
      '<div class="col-2"><label class="lbl-sm">Carga</label><input data-f="cargaHoraria" type="text" class="form-control form-control-sm" value="'+(c.cargaHoraria||'')+'"/></div>'+
      '<div class="col-2"><label class="lbl-sm">Turno</label><input data-f="turno" type="text" class="form-control form-control-sm" value="'+(c.turno||'')+'"/></div>'+
      '<div class="col-2"><label class="lbl-sm">Duração</label><input data-f="duracao" type="text" class="form-control form-control-sm" value="'+(c.duracao||'')+'"/></div>'+
      '<div class="col-3"><label class="lbl-sm">PPC</label><input data-f="linkPPC" type="text" class="form-control form-control-sm" value="'+(c.linkPPC||'')+'"/></div>'+
      '<div class="col-3"><label class="lbl-sm">Link</label><input data-f="linkCurso" type="text" class="form-control form-control-sm" value="'+(c.linkCurso||'')+'"/></div>'+
      '<div class="col-3"><label class="lbl-sm">Coord.</label><input data-f="coordenador" type="text" class="form-control form-control-sm" value="'+(c.coordenador||'')+'"/></div>'+
      '<div class="col-3"><label class="lbl-sm">Email</label><input data-f="email" type="email" class="form-control form-control-sm" value="'+(c.email||'')+'"/></div>'+
      '<div class="col-4"><label class="lbl-sm">Imagem</label><input data-f="imagem" type="text" class="form-control form-control-sm" value="'+(c.imagem||'')+'"/></div>'+
      '<div class="col-8"><label class="lbl-sm">Descrição</label><textarea data-f="descricao" class="form-control form-control-sm" rows="2">'+(c.descricao||'')+'</textarea></div>'+
      '</div>'
    )}

    function wireCourseEvents(){document.querySelectorAll('[data-edit]').forEach(btn=>{btn.addEventListener('click',()=>{const id=btn.getAttribute('data-edit');const el=document.getElementById(id);const bsCollapse=new bootstrap.Collapse(el,{toggle:true})})});document.querySelectorAll('[data-del]').forEach(btn=>{btn.addEventListener('click',()=>{const idx=parseInt(btn.getAttribute('data-del'));state.cursos.splice(idx,1);render()})});document.querySelectorAll('#editor-sections .card .collapse').forEach((col,cardIdx)=>{const idx=findCourseIndexByCollapse(col);const inputs=col.querySelectorAll('input,select,textarea');inputs.forEach(el=>{const f=el.getAttribute('data-f');const apply=(value)=>{setCourseField(idx,f,value,el)};const type=el.tagName==='SELECT'?'change':(el.tagName==='TEXTAREA'?'input':'input');el.addEventListener(type,e=>apply(e.target.value));validateFieldIdx(idx,f,el);markChangedIdx(idx,f,el)})})}
    function autoExpandNew(){const card=document.querySelector('#editor-sections .card.row-dirty');if(card){const col=card.querySelector('.collapse');const bsCollapse=new bootstrap.Collapse(col,{toggle:true});const first=card.querySelector('input[data-f="nome"]')||card.querySelector('input,textarea,select');if(first)first.focus()}}

    function findCourseIndexByCollapse(col){const card=col.closest('.card');const idText=card.querySelector('.card-body small')?.textContent||'';const idMatch=idText.match(/#(\d+)/);const idValue=idMatch?parseInt(idMatch[1]):null;const idx=state.cursos.findIndex(c=>String(c.id)===String(idValue));return idx>=0?idx:0}
    function setCourseField(i,f,value,el){const map={id:v=>{state.cursos[i].id=parseInt(v)||''},nome:v=>{state.cursos[i].nome=v},categoria:v=>{state.cursos[i].categoria=v},status:v=>{state.cursos[i].status=v},vagas:v=>{state.cursos[i].vagas=parseInt(v)||''},cargaHoraria:v=>{state.cursos[i].cargaHoraria=v},turno:v=>{state.cursos[i].turno=v},duracao:v=>{state.cursos[i].duracao=v},linkPPC:v=>{state.cursos[i].linkPPC=v},linkCurso:v=>{state.cursos[i].linkCurso=v},coordenador:v=>{state.cursos[i].coordenador=v},email:v=>{state.cursos[i].email=v},imagem:v=>{state.cursos[i].imagem=v},descricao:v=>{state.cursos[i].descricao=v}};map[f](value);validateFieldIdx(i,f,el);markChangedIdx(i,f,el);updateHeaderAfterEdit(i)}
    function updateHeaderAfterEdit(i){render()}

    function deepCopy(o){return JSON.parse(JSON.stringify(o))}
    function isValidUrl(u){if(!u)return true; if(u==='#')return true; try{const x=new URL(u);return x.protocol==='http:'||x.protocol==='https:'}catch(e){return false}}
    function allIdsUnique(arr){const seen=new Set();for(const c of arr){if(c.id==null||c.id==='')continue;const k=String(c.id);if(seen.has(k))return false;seen.add(k)}return true}
    function validateFieldIdx(i,f,el){const c=state.cursos[i];let ok=true;switch(f){case 'id': ok= c.id!=='' && Number.isFinite(c.id) && c.id>0; break;case 'nome': ok= !!(c.nome&&c.nome.trim()); break;case 'categoria': ok= categorias.includes(c.categoria); break;case 'status': ok= statusList.includes(c.status); break;case 'vagas': ok= c.vagas==='' || (Number.isFinite(c.vagas)&&c.vagas>=0); break;case 'email': ok= !c.email || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c.email); break;case 'linkPPC': ok= isValidUrl(c.linkPPC); break;case 'linkCurso': ok= isValidUrl(c.linkCurso); break;case 'imagem': ok= isValidUrl(c.imagem); break; default: ok=true } el.classList.toggle('is-invalid',!ok);return ok}
    function markChangedIdx(i,f,el){const ori=originalState.cursos[i];const cur=state.cursos[i];let changed=false;if(!ori)changed=true;else{changed=JSON.stringify(ori[f])!==JSON.stringify(cur[f])}el.classList.toggle('changed',changed)}
    function ordenarCursos(){const rankStatus={'Ativo':0,'Inativo':1,'Sem oferta':2};state.cursos.sort((a,b)=>{const ra=rankStatus[a.status]??9, rb=rankStatus[b.status]??9; if(ra!==rb) return ra-rb; const ca=categorias.indexOf(a.categoria), cb=categorias.indexOf(b.categoria); if(ca!==cb) return ca-cb; const na=(a.nome||'').toLowerCase(), nb=(b.nome||'').toLowerCase(); return na.localeCompare(nb)});render()}
    function validarCursos(){let ok=true;state.cursos.forEach((c,i)=>{const inputs=document.querySelectorAll('#editor-sections .card')[i]?.querySelectorAll('input,select,textarea')||[];inputs.forEach(el=>{const f=el.getAttribute('data-f');ok=validateFieldIdx(i,f,el)&&ok})});if(!allIdsUnique(state.cursos)){ok=false;alert('IDs duplicados encontrados')}return ok}

    async function loadFromUrl(url){try{const res=await fetch(url,{cache:'no-store'});if(!res.ok)throw new Error('http '+res.status);const data=await res.json();const cursos=Array.isArray(data.cursos)?data.cursos:Array.isArray(data)?data:[];state={campus:data.campus||'',cursos:cursos};originalState=deepCopy(state);render();bootstrap.Modal.getInstance(document.getElementById('modalAbrir'))?.hide()}catch(e){alert('Falha ao carregar: '+e.message)}}
    function loadFromFile(file){const r=new FileReader();r.onload=()=>{try{const data=JSON.parse(r.result);const cursos=Array.isArray(data.cursos)?data.cursos:Array.isArray(data)?data:[];state={campus:data.campus||'',cursos:cursos};originalState=deepCopy(state);render()}catch(e){alert('JSON inválido')}};r.readAsText(file)}
    function downloadJson(){const payload={cursos:state.cursos};if(state.campus)payload.campus=state.campus;const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});const a=document.createElement('a');const campusSlug=sanitizeCampusParam(state.campus||'');a.href=URL.createObjectURL(blob);a.download=(campusSlug?campusSlug:'cursos')+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a)}
    async function listarRemotos(){const list=document.getElementById('lista-remota');try{const api='https://api.github.com/repos/osnisanches/osnisanches.github.io/contents/ifcode/cursos';const res=await fetch(api,{cache:'no-store',headers:{'Accept':'application/vnd.github.v3+json'}});if(!res.ok)throw new Error('http '+res.status);const arr=await res.json();const files=Array.isArray(arr)?arr.filter(x=>x.type==='file'&&/\.json$/i.test(x.name)):[];list.innerHTML='';files.forEach(x=>{const a=document.createElement('a');a.href='#';a.className='list-group-item list-group-item-action';a.textContent=x.name+' — '+(x.download_url||'');a.addEventListener('click',e=>{e.preventDefault();document.getElementById('input-url').value=x.download_url||''});list.appendChild(a)});if(!files.length){list.innerHTML='<div class="alert alert-warning">Nenhum JSON encontrado em /cursos</div>'}}catch(e){list.innerHTML='';const fallback=['https://osnisanches.github.io/ifcode/cursos/braganca.json'];fallback.forEach(u=>{const a=document.createElement('a');a.href='#';a.className='list-group-item list-group-item-action';a.textContent=u; a.addEventListener('click',ev=>{ev.preventDefault();document.getElementById('input-url').value=u}); list.appendChild(a)});if(!fallback.length){list.innerHTML='<div class="alert alert-danger">Não foi possível listar /cursos</div>'}}}

    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('btn-abrir').addEventListener('click',()=>{new bootstrap.Modal(document.getElementById('modalAbrir')).show()})
      document.getElementById('btn-salvar-menu').addEventListener('click',()=>{new bootstrap.Modal(document.getElementById('modalSalvar')).show()})
      document.getElementById('btn-abrir-local-modal').addEventListener('click',()=>document.getElementById('input-file').click())
      document.getElementById('btn-carregar-url-modal').addEventListener('click',()=>{const inp=document.getElementById('input-url');const url=(inp.value&&inp.value.trim())||inp.placeholder;if(url)loadFromUrl(url)})
      document.getElementById('btn-listar-site').addEventListener('click',()=>listarRemotos())
      const fileInput=document.createElement('input');fileInput.type='file';fileInput.accept='application/json';fileInput.className='d-none';fileInput.id='input-file';document.body.appendChild(fileInput);fileInput.addEventListener('change',e=>{const f=e.target.files[0];if(f)loadFromFile(f)})
      document.getElementById('btn-salvar').addEventListener('click',()=>{if(document.getElementById('chk-ordenar').checked)ordenarCursos();if(document.getElementById('chk-validar').checked){if(!validarCursos()){alert('Corrija os erros antes de salvar');return}}downloadJson();bootstrap.Modal.getInstance(document.getElementById('modalSalvar'))?.hide()})
      document.getElementById('input-campus-nome').addEventListener('input',e=>{state.campus=e.target.value})
      document.getElementById('btn-novo-curso').addEventListener('click',()=>{state.cursos.unshift({id:'',nome:'',categoria:categorias[0],status:'Ativo',vagas:'',cargaHoraria:'',turno:'',duracao:'',linkPPC:'',linkCurso:'',coordenador:'',email:'',imagem:'',descricao:''});render()})
      document.getElementById('filtro-categoria').addEventListener('change',e=>{filtros.categoria=e.target.value;render()})
      document.getElementById('filtro-status').addEventListener('change',e=>{filtros.status=e.target.value;render()})
      document.getElementById('filtro-texto').addEventListener('input',e=>{filtros.texto=e.target.value;render()})
    })
  </script>
</body>
</html>
